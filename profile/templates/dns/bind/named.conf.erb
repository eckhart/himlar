// named.conf

include "/etc/rndc-mdns.key";
include "/etc/rndc-admin.key";

acl iaas_nets {
    172.16.0.0/12;        # internal rfc1918
    158.39.77.0/24;       # bgo IPv4
    158.39.74.0/24;       # bgo IPv4
    158.37.63.0/24;       # osl IPv4
    158.39.75.0/24;       # osl IPv4
    2001:700:2:8300::/56; # bgo IPv6
    2001:700:2:8200::/56; # osl IPv6
};

controls  {
    inet 127.0.0.1 port 953 allow { 127.0.0.1; } keys { "rndc-key-admin"; };
    inet <%= @my_mgmt_addr %> port 953 allow { <%= @admin_mgmt_addr %>; } keys { "rndc-key-admin"; };
    #inet <%= @my_transport_addr %> port 953 allow { <%= @mdns_transport_addr %>; } keys { "rndc-key-mdns"; };
};

options  {
    allow-new-zones yes;
    allow-query { any; };
    allow-query-cache { 127.0.0.1; ::1; iaas_nets; };
    allow-recursion { 127.0.0.1; ::1; iaas_nets; };
    directory "/var/named";
    dnssec-enable yes;
    dnssec-validation yes;
    empty-zones-enable yes;
    listen-on-v6 { any; };
};

#include "/etc/named.<%= @internal_zone %>.conf";

<% if @master %>
zone "<%= @internal_zone %>" {
    type master;
    file "/var/named/<%= @internal_zone %>.zone";
    allow-update { <%= @admin_mgmt_addr %>; };
    allow-query { 127.0.0.1; ::1; iaas_nets; };
};
<% reverse_zones.each do |network, values| -%>
#zone "<%= values["origin"] %>.in-addr.arpa" in{
#    type master;
#    file "/var/named/<%= values["filename"] %>";
#    allow-update { <%= @admin_mgmt_addr %>; };
#    allow-query { 127.0.0.1; ::1; iaas_nets; };
#};
<% end -%>
<% else %>
zone "<%= @internal_zone %>" IN {
    type slave;
    file "/var/named/<%= @internal_zone %>.zone";
    masters { <%= @ns1_transport_addr %>; <%= @ns1_public_addr %>; };
    allow-query { 127.0.0.1; ::1; iaas_nets; };
};
<% reverse_zones.each do |network, values| -%>
#zone "<%= values["origin"] %>.in-addr.arpa" in{
#    type slave;
#    file "/var/named/<%= values["filename"] %>";
#    masters { <%= @ns1_transport_addr %>; <%= @ns1_public_addr %>; };
#    allow-query { 127.0.0.1; ::1; iaas_nets; };
#};
<% end -%>
<% end %>


<% reverse_zones.each do |network, values| -%>
#include "/etc/named.<%= values["filename"] %>.conf";
<% end -%>

include "/etc/named.rfc1912.zones";
