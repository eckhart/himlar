---
# Shared config (nodes: novactrl, compute)
nova::db::database_connection:     "mysql://nova:%{hiera('nova::db::mysql::password')}@%{hiera('service__address__mysql')}/nova"
nova::db::api_database_connection: "mysql://nova_api:%{hiera('nova::db::mysql_api::password')}@%{hiera('service__address__mysql')}/nova_api"
nova::glance_api_servers:          "http://%{hiera('service__address__glance_api')}:9292"
nova::cinder_catalog_info:         'volumev2:cinderv2:internalURL'
nova::os_region_name:              "%{location}"

# logging
nova::use_syslog:           true
nova::log_facility:         'LOG_LOCAL0'

# rabbit mq (for rabbit_password see secrets)
nova::rabbit_userid:        'nova'
nova::rabbit_virtual_host:  'nova'
nova::rabbit_hosts:
  - "%{hiera('service__address__rabbitmq_01')}:5672"
  - "%{hiera('service__address__rabbitmq_02')}:5672"
  - "%{hiera('service__address__rabbitmq_03')}:5672"

# mysql database (node: db)
nova::db::mysql::allowed_hosts:
  - "%{netpart_transport1}.%" # FIXME
nova::db::mysql_api::allowed_hosts:
  - "%{netpart_transport1}.%" # FIXME

# keystone auth (node: identity)
nova::keystone::auth::region:           "%{location}"
nova::keystone::auth::password:         "%{hiera('nova_api_password')}"
nova::keystone::auth::public_url:       "%{hiera('endpoint_protocol')}://%{hiera('service__address__nova_public_api')}:8774/v2/%(tenant_id)s"
nova::keystone::auth::public_url_v3:    "%{hiera('endpoint_protocol')}://%{hiera('service__address__nova_public_api')}:8774/v3"
nova::keystone::auth::admin_url:        "http://%{hiera('service__address__nova_api')}:8774/v2/%(tenant_id)s"
nova::keystone::auth::admin_url_v3:     "http://%{hiera('service__address__nova_api')}:8774/v3"
nova::keystone::auth::internal_url:     "http://%{hiera('service__address__nova_api')}:8774/v2/%(tenant_id)s"
nova::keystone::auth::internal_url_v3:  "http://%{hiera('service__address__nova_api')}:8774/v3"

# api (node: novactrl)
nova::api::enabled_apis:                [ 'ec2', 'osapi_compute' ]
nova::api::enabled:                     true
nova::api::api_bind_address:            "%{ipaddress_transport1}"
nova::api::admin_password:              "%{hiera('nova_api_password')}"
nova::api::auth_uri:                    "http://%{hiera('service__address__keystone')}:5000/"
nova::api::identity_uri:                "http://%{hiera('service__address__keystone_admin')}:35357/"

# scheduler (node: novactrl)
nova::scheduler::enabled:                         true
nova::scheduler::filter::ram_allocation_ratio:    '1.5'
nova::scheduler::filter::max_instances_per_host:  '75'
nova::scheduler::filter::disk_allocation_ratio:   '10'
nova::scheduler::filter::cpu_allocation_ratio:    '16'

# conductor (node: novactrl)
nova::conductor::enabled: true

# consoleauth (node: novactrl)
nova::consoleauth::enabled: true

# neutron network (node: compute and novactrl)
nova::network::neutron::neutron_url:            "http://%{hiera('service__address__neutron_server')}:9696"
nova::network::neutron::neutron_auth_url:  "http://%{hiera('service__address__keystone_admin')}:35357/v3"
nova::network::neutron::neutron_region_name:    "%{location}"
nova::network::neutron::neutron_password: "%{hiera('neutron_api_password')}"

# compute (node: compute)
nova::compute::enabled:                         true
nova::compute::rbd::libvirt_rbd_user:           'cinder'
nova::compute::rbd::libvirt_rbd_secret_uuid:    '363cb82c-793f-4aff-93f5-3332376c4369'
nova::compute::rbd::libvirt_images_rbd_pool:    'volumes'
nova::compute::rbd::rbd_keyring:                'client.cinder'
nova::compute::rbd::ephemeral_storage:          false
nova::compute::rbd::manage_ceph_client:         false

# VNC
#nova::compute::vnc_enabled: true
#nova::compute::vncserver_proxyclient_address: "%{ipaddress_mgmt1}"
#nova::compute::vncproxy_host: "%{hiera('service__address__consoleproxy')}"
#nova::compute::vncproxy_protocol: 'https'
#nova::compute::libvirt::vncserver_listen: "%{ipaddress_mgmt1}"
# SPICE testing
nova::compute::vnc_enabled:                       false
nova::compute::spice::server_proxyclient_address: "%{ipaddress_mgmt1}"
nova::compute::spice::proxy_host:                 "%{hiera('service__address__consoleproxy')}"
nova::compute::spice::proxy_protocol:             'https'
nova::compute::spice::server_listen:              "%{ipaddress_mgmt1}"
